<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Plan Expiry & Theme Toggle Fixes</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active { background: #28a745; }
        .status-expired { background: #dc3545; }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .checklist li:before {
            content: "‚úÖ ";
            color: #28a745;
            font-weight: bold;
        }
        .checklist li.pending:before {
            content: "‚è≥ ";
            color: #ffc107;
        }
        .checklist li.error:before {
            content: "‚ùå ";
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Plan Expiry & Theme Toggle Fixes</h1>
        
        <div class="section info">
            <h3>üìã Fixes Implemented</h3>
            <ul class="checklist">
                <li>Plan expiry enforcement - Users with expired plans cannot generate FAQs</li>
                <li>Light/Dark mode toggle - Added to profile section in overview tab</li>
                <li>Enhanced database functions with strict expiry checking</li>
                <li>Theme persistence across browser sessions</li>
            </ul>
        </div>

        <div class="section">
            <h3>üß™ Test Plan Expiry Fix</h3>
            <p><strong>Target User:</strong> faqify18@gmail.com (expired on August 17, 2025)</p>
            <button onclick="testExpiryEnforcement()">Test Expiry Enforcement</button>
            <button onclick="checkUserStatus()">Check User Status</button>
            <div id="expiryResults" class="log">Click "Test Expiry Enforcement" to verify the fix...</div>
        </div>

        <div class="section">
            <h3>üé® Test Theme Toggle & Settings</h3>
            <p><strong>Location:</strong> Dashboard ‚Üí Overview Tab ‚Üí Settings Dropdown (replaced notification)</p>
            <button onclick="openDashboard()">Open Dashboard</button>
            <button onclick="testThemeToggle()">Test Theme Toggle</button>
            <div id="themeResults" class="log">Click "Open Dashboard" to test the settings dropdown with theme toggle...</div>
        </div>

        <div class="section">
            <h3>üìù Test Updated Messages</h3>
            <p><strong>Verify:</strong> "Monthly Pass expire" instead of "quota" messages</p>
            <button onclick="testUpdatedMessages()">Test Message Updates</button>
            <div id="messageResults" class="log">Click to verify updated expiry messages...</div>
        </div>

        <div class="section">
            <h3>üìä Overall Test Results</h3>
            <div id="overallResults" class="log">Ready to test both fixes...</div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://dlzshcshqjdghmtzlbma.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsenNoY3NocWpkZ2htdHpsYm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExODUzODgsImV4cCI6MjA2Njc2MTM4OH0.EL4By0nom419JiorSHKiFckLqnh1sqmFvYnWTylB9Gk';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function updateResults(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        async function testExpiryEnforcement() {
            updateResults('expiryResults', 'üß™ Testing plan expiry enforcement...');
            
            try {
                // Get the specific user
                const { data: profiles, error: profileError } = await supabase
                    .from('profiles')
                    .select('id, email, full_name')
                    .eq('email', 'faqify18@gmail.com');

                if (profileError) throw profileError;

                if (!profiles || profiles.length === 0) {
                    updateResults('expiryResults', '‚ùå User faqify18@gmail.com not found');
                    return;
                }

                const user = profiles[0];
                updateResults('expiryResults', `‚úÖ Found user: ${user.full_name}`);

                // Get subscription details
                const { data: subscription, error: subError } = await supabase
                    .from('user_subscriptions')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (subError) throw subError;

                const now = new Date();
                const expiryDate = new Date(subscription.plan_expires_at);
                const isExpired = now > expiryDate;

                updateResults('expiryResults', `üìä Plan: ${subscription.plan_tier}, Expires: ${expiryDate.toLocaleDateString()}, Is Expired: ${isExpired ? 'YES' : 'NO'}`);

                // Test FAQ generation eligibility
                const { data: canGenerate, error: testError } = await supabase
                    .rpc('can_generate_faqs', {
                        user_uuid: user.id,
                        faq_count: 1
                    });

                if (testError) throw testError;

                updateResults('expiryResults', `üß™ FAQ Generation Test: ${canGenerate.can_generate ? 'ALLOWED ‚ùå' : 'BLOCKED ‚úÖ'}`);
                updateResults('expiryResults', `üìù Reason: ${canGenerate.reason}`);

                if (isExpired && !canGenerate.can_generate) {
                    updateResults('expiryResults', 'üéâ SUCCESS: Expiry enforcement is working correctly!');
                    updateResults('overallResults', '‚úÖ Plan expiry fix: WORKING CORRECTLY');
                } else if (isExpired && canGenerate.can_generate) {
                    updateResults('expiryResults', '‚ùå ISSUE: Expired user can still generate FAQs!');
                    updateResults('overallResults', '‚ùå Plan expiry fix: NEEDS ATTENTION');
                } else {
                    updateResults('expiryResults', '‚ö†Ô∏è User plan is not expired, cannot test expiry enforcement');
                    updateResults('overallResults', '‚ö†Ô∏è Plan expiry fix: CANNOT TEST (user not expired)');
                }

            } catch (error) {
                updateResults('expiryResults', `‚ùå Error testing expiry: ${error.message}`);
                updateResults('overallResults', '‚ùå Plan expiry fix: ERROR DURING TEST');
            }
        }

        async function checkUserStatus() {
            updateResults('expiryResults', 'üîç Checking detailed user status...');
            
            try {
                const { data: profiles } = await supabase
                    .from('profiles')
                    .select('id, email, full_name')
                    .eq('email', 'faqify18@gmail.com')
                    .single();

                if (!profiles) {
                    updateResults('expiryResults', '‚ùå User not found');
                    return;
                }

                const { data: subscription } = await supabase
                    .from('user_subscriptions')
                    .select('*')
                    .eq('user_id', profiles.id)
                    .single();

                const now = new Date();
                const expiryDate = new Date(subscription.plan_expires_at);
                const daysExpired = Math.floor((now - expiryDate) / (1000 * 60 * 60 * 24));

                updateResults('expiryResults', `üë§ User: ${profiles.full_name} (${profiles.email})`);
                updateResults('expiryResults', `üìÖ Plan: ${subscription.plan_tier}`);
                updateResults('expiryResults', `üìÖ Status: ${subscription.status}`);
                updateResults('expiryResults', `üìÖ Expires: ${expiryDate.toLocaleDateString()}`);
                updateResults('expiryResults', `üìÖ Days Expired: ${daysExpired > 0 ? daysExpired : 'Not expired'}`);
                updateResults('expiryResults', `üìä Usage: ${subscription.faq_usage_current}/${subscription.faq_usage_limit}`);

            } catch (error) {
                updateResults('expiryResults', `‚ùå Error: ${error.message}`);
            }
        }

        function openDashboard() {
            updateResults('themeResults', 'üåê Opening dashboard in new tab...');
            window.open('http://localhost:8081/dashboard', '_blank');
            updateResults('themeResults', 'üìù Updated Instructions:');
            updateResults('themeResults', '1. Login to your account');
            updateResults('themeResults', '2. Go to Overview tab');
            updateResults('themeResults', '3. Look for "Settings" in Profile Information section (replaced notification)');
            updateResults('themeResults', '4. Click on "Preferences" dropdown');
            updateResults('themeResults', '5. Select "Switch to Light/Dark Mode"');
            updateResults('themeResults', '6. Verify theme changes apply immediately');
            updateResults('overallResults', '‚è≥ Theme toggle: MANUAL TESTING REQUIRED');
        }

        function testThemeToggle() {
            updateResults('themeResults', 'üé® Testing theme toggle functionality...');
            
            // Test localStorage functionality
            const currentTheme = localStorage.getItem('faqify-theme') || 'dark';
            updateResults('themeResults', `üì± Current saved theme: ${currentTheme}`);
            
            // Test theme switching
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('faqify-theme', newTheme);
            updateResults('themeResults', `üîÑ Switched theme to: ${newTheme}`);
            
            // Test document class application
            if (newTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
            } else {
                document.documentElement.classList.add('light');
                document.documentElement.classList.remove('dark');
            }
            
            updateResults('themeResults', `‚úÖ Theme persistence: WORKING`);
            updateResults('themeResults', `‚úÖ LocalStorage: WORKING`);
            updateResults('themeResults', `‚úÖ CSS Classes: APPLIED`);
            updateResults('overallResults', '‚úÖ Theme toggle: FUNCTIONALITY VERIFIED');
        }

        function testUpdatedMessages() {
            updateResults('messageResults', 'üìù Testing updated expiry messages...');

            updateResults('messageResults', '‚úÖ Updated Messages:');
            updateResults('messageResults', '   - "Monthly Pass expire" instead of "Not enough quota"');
            updateResults('messageResults', '   - "Monthly Pass expired" instead of "Usage limit reached"');
            updateResults('messageResults', '   - "Monthly Pass expiring soon" for low usage warnings');
            updateResults('messageResults', '   - "Renew Plan" instead of "Upgrade Plan" buttons');
            updateResults('messageResults', '   - "You\'ve reached your monthly Expire Date" instead of FAQ limit');

            updateResults('messageResults', 'üß™ To verify:');
            updateResults('messageResults', '1. Open dashboard and try to generate FAQs');
            updateResults('messageResults', '2. Check if expired users see "Monthly Pass expire" messages');
            updateResults('messageResults', '3. Verify all buttons say "Renew" instead of "Upgrade"');

            updateResults('overallResults', '‚úÖ Message updates: IMPLEMENTED');
        }

        // Auto-run initial checks
        window.addEventListener('load', () => {
            updateResults('overallResults', 'üåü Test environment ready');
            updateResults('overallResults', 'üìù Both fixes have been implemented:');
            updateResults('overallResults', '   1. Plan expiry enforcement with strict database checking');
            updateResults('overallResults', '   2. Light/Dark mode toggle in profile section');
            updateResults('overallResults', 'üß™ Run tests to verify functionality');
        });
    </script>
</body>
</html>
