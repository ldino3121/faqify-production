<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQify Payment System Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: #2a2a2a; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .result { background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß FAQify Payment System Diagnostic</h1>

        <div class="test-section">
            <h2>1. Database Plan Check</h2>
            <button onclick="checkDatabasePlans()">Check Database Plans</button>
            <div id="dbResult"></div>
        </div>

        <div class="test-section">
            <h2>2. Edge Function Test</h2>
            <button onclick="testSubscriptionFunction()">Test Subscription Function</button>
            <button onclick="testOrderFunction()">Test Order Function</button>
            <div id="edgeResult"></div>
        </div>

        <div class="test-section">
            <h2>3. Frontend Component Test</h2>
            <button onclick="testFrontendPricing()">Test Frontend Pricing</button>
            <div id="frontendResult"></div>
        </div>

        <div class="test-section">
            <h2>4. Complete Payment Flow Test</h2>
            <button onclick="testCompleteFlow()">Test Complete Flow</button>
            <div id="flowResult"></div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://dlzshcshqjdghmtzlbma.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsenNoY3NocWpkZ2htdHpsYm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjAwMjI0NzEsImV4cCI6MjAzNTU5ODQ3MX0.Vdwq7NjXKGkpOEBKAMA_VXnyIgNy8NVWjBe_-Ug_Ue4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = content;
            element.appendChild(resultDiv);
        }

        async function checkDatabasePlans() {
            log('üîç Checking database plans...');
            displayResult('dbResult', 'üîç Checking database subscription plans...', 'info');

            try {
                const { data, error } = await supabase
                    .from('subscription_plans')
                    .select('*')
                    .order('price_monthly');

                if (error) throw error;

                let resultHTML = '<h3>üìä Database Plans:</h3>';
                data.forEach(plan => {
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: #1a1a1a; border-radius: 4px;">
                            <strong>${plan.name}</strong><br>
                            üí∞ Price Monthly: ${plan.price_monthly}<br>
                            üí∞ Price INR: ${plan.price_inr || 'Not set'}<br>
                            üìä FAQ Limit: ${plan.faq_limit}<br>
                            üîë Razorpay Plan ID (INR): ${plan.razorpay_plan_id_inr || 'Not set'}<br>
                            üîë Razorpay Plan ID (Old): ${plan.razorpay_plan_id || 'Not set'}
                        </div>
                    `;
                });

                displayResult('dbResult', resultHTML, 'success');

                // Check if we have the correct plan IDs
                const proPlan = data.find(p => p.name === 'Pro');
                const businessPlan = data.find(p => p.name === 'Business');

                if (proPlan?.razorpay_plan_id_inr === 'plan_RGcv1a3WtevwV8' &&
                    businessPlan?.razorpay_plan_id_inr === 'plan_RGcucvclIXXAgp') {
                    displayResult('dbResult', '‚úÖ Database has correct plan IDs!', 'success');
                } else {
                    displayResult('dbResult', '‚ùå Database missing correct plan IDs. Need to run SQL update.', 'error');
                }

            } catch (error) {
                displayResult('dbResult', `‚ùå Database Error: ${error.message}`, 'error');
            }
        }

        async function testSubscriptionFunction() {
            log('üß™ Testing subscription edge function...');
            displayResult('edgeResult', 'üß™ Testing create-razorpay-subscription function...', 'info');

            try {
                const { data, error } = await supabase.functions.invoke('create-razorpay-subscription', {
                    body: {
                        planId: 'Pro',
                        userEmail: 'test@example.com',
                        userName: 'Test User',
                        currency: 'INR',
                        userCountry: 'IN'
                    }
                });

                if (error) throw error;

                displayResult('edgeResult', `
                    <h3>‚úÖ Subscription Function Response:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `, 'success');

            } catch (error) {
                displayResult('edgeResult', `‚ùå Subscription Function Error: ${error.message}`, 'error');
            }
        }

        async function testOrderFunction() {
            log('üß™ Testing order edge function...');
            displayResult('edgeResult', 'üß™ Testing create-razorpay-order function...', 'info');

            try {
                const { data, error } = await supabase.functions.invoke('create-razorpay-order', {
                    body: {
                        planId: 'Pro',
                        currency: 'inr',
                        userCountry: 'IN',
                        paymentType: 'onetime'
                    }
                });

                if (error) throw error;

                displayResult('edgeResult', `
                    <h3>‚úÖ Order Function Response:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `, 'success');

            } catch (error) {
                displayResult('edgeResult', `‚ùå Order Function Error: ${error.message}`, 'error');
            }
        }

        async function testFrontendPricing() {
            log('üé® Testing frontend pricing...');
            displayResult('frontendResult', 'üé® Testing frontend pricing display...', 'info');

            // Simulate the frontend pricing logic
            const plans = [
                {
                    id: 'free',
                    name: 'Free',
                    price_monthly: 0,
                    faq_limit: 10
                },
                {
                    id: 'pro',
                    name: 'Pro',
                    price_monthly: 750,
                    faq_limit: 100
                },
                {
                    id: 'business',
                    name: 'Business',
                    price_monthly: 2500,
                    faq_limit: 500
                }
            ];

            const getPrice = (plan) => {
                return {
                    amount: plan.price_monthly,
                    symbol: '‚Çπ',
                    currency: 'INR'
                };
            };

            let resultHTML = '<h3>üí∞ Frontend Pricing Display:</h3>';
            plans.forEach(plan => {
                const price = getPrice(plan);
                resultHTML += `
                    <div style="margin: 10px 0; padding: 10px; background: #1a1a1a; border-radius: 4px;">
                        <strong>${plan.name}</strong><br>
                        üí∞ Display: ${price.symbol}${price.amount}<br>
                        üìä FAQ Limit: ${plan.faq_limit} per month
                    </div>
                `;
            });

            displayResult('frontendResult', resultHTML, 'success');
        }

        async function testCompleteFlow() {
            log('üîÑ Testing complete payment flow...');
            displayResult('flowResult', 'üîÑ Testing complete payment flow...', 'info');

            // Test the complete flow
            try {
                // Step 1: Check database
                displayResult('flowResult', '1Ô∏è‚É£ Checking database plans...', 'info');
                await checkDatabasePlans();

                // Step 2: Test edge functions
                displayResult('flowResult', '2Ô∏è‚É£ Testing edge functions...', 'info');
                await testSubscriptionFunction();
                await testOrderFunction();

                // Step 3: Test frontend
                displayResult('flowResult', '3Ô∏è‚É£ Testing frontend pricing...', 'info');
                await testFrontendPricing();

                displayResult('flowResult', '‚úÖ Complete flow test finished! Check results above.', 'success');

            } catch (error) {
                displayResult('flowResult', `‚ùå Complete Flow Error: ${error.message}`, 'error');
            }
        }

        // Auto-run basic checks on page load
        window.addEventListener('load', () => {
            log('üöÄ FAQify Payment System Diagnostic loaded');
            displayResult('dbResult', 'üëã Ready to test! Click buttons above to run diagnostics.', 'info');
        });
    </script>
</body>
</html>